---
layout: post
title: Measuring Audio Latency
author: Chip
image: https://2.bp.blogspot.com/-sM0-P9-sosQ/WmIf-wQkI1I/AAAAAAAAEW0/2Wsv8yTDUPIgdYNip10vaC_JsVmQRmk_QCLcBGAs/s640/Photo%2Bof%2BSetup.png
---


For real-time audio processing, it is often important to minimize the delay between audio coming out of the system compared to the audio coming into the system.&nbsp; This is especially true of hearing aids, where too much latency can cause the listener to perceive an echo (or have a comb-filtering effect), which end up degrading rather than helping the listener's experience.&nbsp; Research <a href="https://www.ncbi.nlm.nih.gov/pubmed/15809547">suggests</a>&nbsp;that the maximum tolerable latency in a hearing aid is only 14-30 msec.&nbsp; If Tympan wants to be helpful, we need to make sure that we keep our latency shorter than this.&nbsp; Let's find out what our system does!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-sM0-P9-sosQ/WmIf-wQkI1I/AAAAAAAAEW0/2Wsv8yTDUPIgdYNip10vaC_JsVmQRmk_QCLcBGAs/s1600/Photo%2Bof%2BSetup.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="599" data-original-width="811" height="354" src="https://2.bp.blogspot.com/-sM0-P9-sosQ/WmIf-wQkI1I/AAAAAAAAEW0/2Wsv8yTDUPIgdYNip10vaC_JsVmQRmk_QCLcBGAs/s640/Photo%2Bof%2BSetup.png" width="480" /></a></div><br /><u>Test Setup.</u>&nbsp; To measure the latency of the Tympan, we need to inject an audio signal into the Tympan and then measure delay of the output audio relative to the input audio.&nbsp; There's lots of ways that this can be done.&nbsp; I chose to use the setup shown in the picture above.&nbsp; In this setup, I generate my test audio signals from my PC.&nbsp; I use a series of 1 kHz tone bursts that are 1 second long.&nbsp; The audio comes out of my PC and (as shown in the red line) is split so that it goes to the input of the Tympan *and* to the input of an audio recorder.&nbsp; The output of the Tympan is then (as shown in the blue line) routed to the other input of the audio recorder.&nbsp; The stereo audio file produced by the audio recorder will contain the input audio in the left channel and the output audio in the right channel.&nbsp; It will then be a simple post-processing analysis to measure the delay between the two channels.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-XWmKraoBAws/WmIgU57ZpKI/AAAAAAAAEW4/K5JkNWIi0yIRYAkUjiMLzNLiUHZbiKa8ACLcBGAs/s1600/wave%2Bpackets.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="643" data-original-width="909" height="282" src="https://4.bp.blogspot.com/-XWmKraoBAws/WmIgU57ZpKI/AAAAAAAAEW4/K5JkNWIi0yIRYAkUjiMLzNLiUHZbiKa8ACLcBGAs/s400/wave%2Bpackets.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><u>Raw Data.</u>&nbsp; An example recording and an example Matlab processing script are in my GitHub&nbsp;<a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2018-01-19%20Measuring%20Latency/Data">here</a>.&nbsp;&nbsp;The plot above shows the example data.&nbsp; As you can see, there are three tone bursts in the recording.&nbsp; At this timescale, one cannot see any delay between the signals, but that is because we are not zoomed in enough.&nbsp; The plot below zooms in to the start of one of the tone bursts.&nbsp; Here, we definitely see that the Tympan output has a slight delay relative to the direct audio signal.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-8iCwxBQ_PY8/WmIgZeFJhcI/AAAAAAAAEW8/ORnU62oEyfsmK2lX1vpKHqft8CGibHeMQCLcBGAs/s1600/wave%2Bpackets%2B-%2Bzoom.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="642" data-original-width="909" height="282" src="https://1.bp.blogspot.com/-8iCwxBQ_PY8/WmIgZeFJhcI/AAAAAAAAEW8/ORnU62oEyfsmK2lX1vpKHqft8CGibHeMQCLcBGAs/s400/wave%2Bpackets%2B-%2Bzoom.png" width="400" /></a></div><br /><u>Analysis.</u>&nbsp; Using the plot above, we could visually assess the latency between the two channels.&nbsp; But, to do even better, I included a Matlab script in the GitHub directory that computes the cross-correlation between the two channels.&nbsp; The best estimate of the latency will be when when the cross-correlation is maximum.&nbsp; For this recording, the best estimate of the latency is 3.1 msec.&nbsp; That's nice and short!<br /><br /><u>Measuring other Tympan Configurations.</u>&nbsp; Expanding from this single measurement, I then repeated the process and measured the latency for a variety of different configurations of the Tympan.&nbsp; I tried different audio block sizes and I tried different audio processing algorithms.&nbsp; My results are shown in the figure below.&nbsp; The simple 3.1 msec value reported above can be seen in the bottom-left of the plot as the first point on the yellow line.&nbsp; All of the other configurations result in increased latency, but there are still a lot of configurations that are shorter than the 14-30 msec upper limit from the literature.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-OfLltQylm68/WmIjXLZJTVI/AAAAAAAAEXQ/XbteEpxPovEtVwNK8BL38a9sgTFSgIyuQCLcBGAs/s1600/Results.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="553" data-original-width="746" height="296" src="https://1.bp.blogspot.com/-OfLltQylm68/WmIjXLZJTVI/AAAAAAAAEXQ/XbteEpxPovEtVwNK8BL38a9sgTFSgIyuQCLcBGAs/s400/Results.png" width="400" /></a></div><br /><u>Components of the Latency</u>.&nbsp; After working with the system for a while, I've identified three contributors to the latency:<br /><br /><ul><li>Hardware:&nbsp; The audio interface for the Tympan is a TI 3206 AIC.&nbsp; This chip has a pipeline that is 17 samples long on the input and 21 samples long for the output.&nbsp; So, for this round-trip testing, it contributes 38 samples of latency, which at sample rate of 24 kHz is a latency of 1.58 msec.</li><li>Audio Library:&nbsp; The Tympan audio library is based on the Teensy audio library, which has employs a queue of two audio blocks in order to prevent audio hiccups and drop-outs.&nbsp; In the Tympan library, this audio block size is configurable, hence my ability to make the graph above where I vary the block size.&nbsp; For a block size of 16 samples, the library's latency is 2*16=32 samples, which is 1.33 msec at 24 kHz.&nbsp; Totaled with the hardware latency (1.58 msec&nbsp;+ 1.33 msec), we get 2.9 msec, which is very close to the 3.1 msec value that I measured.&nbsp; Great!</li><li>Audio Processing:&nbsp; Beyond the audio library, most any actual audio processing will also introduce additional latency.&nbsp; A typical (symmetric) FIR filter, for example, will result in a group delay that is half the length of the FIR filter.&nbsp; Other filters and other operations (such as FFT) introduce delays as well.&nbsp; The specific amount of latency may vary, but some latency is inherent in the math.&nbsp; For the Tympan, we see the latency for FIR and FFT in the graph above.</li></ul><u>Optimizing for Minimum Latency.</u>&nbsp; From this exploration, I've learned that latency can be minimized by (1) using the shortest audio block size that the system can handle and (2) running the simplest audio processing algorithm that you can get away with.&nbsp; On this latter point, we all want our audio processing to have extremely fine frequency resolution.&nbsp; But, high resolution requires long FIR filters or long FFTs.&nbsp; Long FIRs/FFTs introduce a lot of latency, however.&nbsp; So, if you want low latency, you need to use the shortest FIRs and FFTs that you can.<br /><br />
