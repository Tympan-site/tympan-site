---
layout: post
title: Reducing Current Draw
author: Chip
---


My <a href="http://openaudio.blogspot.com/2016/11/a-teensy-hearing-aid.html">previous post</a> introduced my Teensy-based hearing aid. &nbsp;While my primary goal was to make a platform for developing audio processing algorithms, I am interested in exploring its performance as an actual hearing assistive device. &nbsp;From this viewpoint, battery life is important. &nbsp;In assembling my device, however, I gave no thought to minimizing power consumption. &nbsp;Does it draw too much current? &nbsp;Will it have a usable battery life? &nbsp;Let's find out!<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-4ryvhKaI4O8/WDmpxoUQ2_I/AAAAAAAAEB8/hY_ChNMkHEk_1vQFK0v1zHI8TfZw0QL2wCK4B/s1600/LeadFigure.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="268" src="https://2.bp.blogspot.com/-4ryvhKaI4O8/WDmpxoUQ2_I/AAAAAAAAEB8/hY_ChNMkHEk_1vQFK0v1zHI8TfZw0QL2wCK4B/s400/LeadFigure.png" width="400" /></a></div><br /><u>Initial Measurements:</u>&nbsp; With my baseline <a href="http://openaudio.blogspot.com/2016/11/a-teensy-hearing-aid.html">Teensy Hearing Aid</a>, I measuring the current being drawn from the battery during normal operation. &nbsp;At this early stage of development, the Teensy isn't doing very much -- it is simply applying digital gain to the audio stream. &nbsp;Because it is doing so little, I am hoping that we'll see the lowest power consumption. &nbsp;My results are below. &nbsp;Note that I measured the power consumption across a range of processor speeds. &nbsp;You can set the speed of the processor via the Arduino IDE when you compile the sketch.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-hCYms2uWhfk/WDmtdjHRqUI/AAAAAAAAECM/9yPr7kETBdw6mWU7wR0aC8R8astO_mdiwCK4B/s1600/Graph-CurrentDraw-delay.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="286" src="https://3.bp.blogspot.com/-hCYms2uWhfk/WDmtdjHRqUI/AAAAAAAAECM/9yPr7kETBdw6mWU7wR0aC8R8astO_mdiwCK4B/s400/Graph-CurrentDraw-delay.png" width="400" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"></div><u>That's A Lot of Current!</u>&nbsp; I was surprised to find that at its normal speed (180 MHz) the system was drawing almost 91 mA of current. &nbsp;That's a lot of current. &nbsp;My battery has a capacity of 350 mA-hours, so my battery life will only be about (350 mA-hrs / 91 mA) = 3.8 hours. &nbsp;For a "hearing aid", this is pretty short. &nbsp;Yes, I could slow down the processor to reduce my power consumption, but this is an inelegant solution that requires me (the programmer) to ensure that my software will always live happily within the limits of the slower speed. &nbsp;I'd prefer a more dynamic approach, where the code itself will switch between low-power and high-performance modes as the workload demands. &nbsp;I don't know how to do that.<br /><br /><u>Sleep During Idle:</u>&nbsp; Luckily, I have a friend who is experienced with low power embedded systems. &nbsp;He suggested that I could save a lot of power by putting the processor to sleep during idle periods. &nbsp;Knowing that I'm working with an ARM processor (the heart of the Teensy board), he suggested that I insert the ARM-specific command <span style="font-family: Courier New, Courier, monospace;">asm(" WFI")</span> into my main loop (yes, you do need the space before the <span style="font-family: Courier New, Courier, monospace;">W</span><span style="font-family: inherit;">). &nbsp;When the processor hits this command, it'll go to sleep and consume less power. &nbsp;It'll stay asleep and "Wait For Interrupt" (hence "WFI") before waking to resume its work.</span><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-VBOl4zA6CXs/WDm4sboqf7I/AAAAAAAAECo/nHAuuZC4U4UzlMw0wsdw5Z82OiygmIK1wCK4B/s1600/ArduinoIDE.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="340" src="https://3.bp.blogspot.com/-VBOl4zA6CXs/WDm4sboqf7I/AAAAAAAAECo/nHAuuZC4U4UzlMw0wsdw5Z82OiygmIK1wCK4B/s400/ArduinoIDE.png" width="400" /></a></div><br /><u>Wait for Interrupt:</u>&nbsp; &nbsp;Since I don't want it to sleep forever, I need to make sure that there is an interrupt (such as a timer) that'll wake the system periodically so that it can do its work. &nbsp;As I don't know how to do this, I have a problem. &nbsp;Luckily, I know that the Teensy Audio Library already uses interrupts to do its work. &nbsp;I know that it fires at least one interrupt every 128 audio samples. &nbsp;As <i>any</i>&nbsp;interrupt will trigger the WFI to wake up, I don't need to do anything more. &nbsp;I can just add the WFI command and rely upon the Audio Library to wake the system. &nbsp;The system will automatically go back and forth between sleep and wake. &nbsp;One line of code -- what a simple solution.<br /><u><br /></u><u>It Works!</u>&nbsp; After adding the WFI command (my code is <a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2016-11-23%20Teensy%203.6%20Current%20Draw/BasicGain_WFI">here</a>), I measured the current draw again. &nbsp;The WFI command works! &nbsp;At the default speed of 180 MHz, the system now draws only 57 mA, instead of 91 mA as seen before. &nbsp;That's a 34 mA savings with no impact on system performance. &nbsp;Fantastic.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-4TV-dpH3qG8/WDm7yt77m2I/AAAAAAAAEC0/unJnme8jMPMwUXcISlIiBmE7QqGIW35cQCK4B/s1600/Graph-CurrentDraw.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="286" src="https://1.bp.blogspot.com/-4TV-dpH3qG8/WDm7yt77m2I/AAAAAAAAEC0/unJnme8jMPMwUXcISlIiBmE7QqGIW35cQCK4B/s400/Graph-CurrentDraw.png" width="400" /></a></div><br /><u>Battery Life:</u>&nbsp; By adding the WFI command, power consumption has dropped to 2/3 of its original value. &nbsp;My system will now have 50% more battery life. &nbsp;Using my 350 mA-hr battery, I'll now get 6 hours of life instead of 4 hours. &nbsp;That's a great improvement for adding just a single line of code.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-4VY3fZ065EA/WDWJVZaVYrI/AAAAAAAAEBQ/OME-MNexDKsWUt_0haQ3-4yBd9vfehFGACEw/s1600/Graph-BatteryLife.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="286" src="https://4.bp.blogspot.com/-4VY3fZ065EA/WDWJVZaVYrI/AAAAAAAAEBQ/OME-MNexDKsWUt_0haQ3-4yBd9vfehFGACEw/s400/Graph-BatteryLife.png" width="400" /></a></div><br /><u>More Power Savings?</u>&nbsp; While increasing my battery life by 50% is great, I went back to my friend asking if more savings could be had so easily. &nbsp;He said that I could save more power, but not nearly as easily. &nbsp;He said that the next step would be to identify and disable peripherals that I don't need. &nbsp;But, to do this, I'd have to read through and understand my processor's datasheet, which is not an easy task for a newbie such as myself. &nbsp;So, for now, I think that I'll be content with the easy savings provided by the WFI command.<br /><br /><u>For Fellow Nerds...My Raw Data:</u>&nbsp; For anyone who is really interested, my raw data is in the table below (or&nbsp;<a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2016-11-23%20Teensy%203.6%20Current%20Draw">here</a>). &nbsp;It is interesting that, even at very slow processor speeds, I still see power savings when using the WFI command. &nbsp;Clearly, my "Gain Only" audio processing algorithm requires very little effort from the processor. &nbsp;That Teensy 3.6 sure is fast!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-I6BPG_QLxBs/WDna4id-1JI/AAAAAAAAEDI/VRYI6SOmsS0GJqiBR-BalnuxZBYfhL6JwCK4B/s1600/CurrentDrawTable%2B-%2BSmaller.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="266" src="https://4.bp.blogspot.com/-I6BPG_QLxBs/WDna4id-1JI/AAAAAAAAEDI/VRYI6SOmsS0GJqiBR-BalnuxZBYfhL6JwCK4B/s320/CurrentDrawTable%2B-%2BSmaller.png" width="320" /></a></div><br />
