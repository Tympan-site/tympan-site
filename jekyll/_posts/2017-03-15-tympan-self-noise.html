---
layout: post
title: Tympan Electronics and Its Self-Noise
author: Chip
image: https://1.bp.blogspot.com/-6Pbu0oaygzs/WMhFxsrBkbI/AAAAAAAAEMs/8RxOegf6xYYhUgdf5kafvUGLioqpVxYjwCLcB/s400/TympanSelfNoiseLeadPic.png
---


After measuring the audio performance of the Teensy Audio Board (see my <a href="http://openaudio.blogspot.com/2017/03/teensy-audio-board-self-noise.html">previous post</a>), I felt that I needed something better. &nbsp;If I wanted my open-source hearing aid ("<a href="http://openaudio.blogspot.com/2017/03/unifying-electronics-to-make-tympan.html">Tympan</a>") to sound good, I needed a quieter audio interface with a bigger dynamic range. &nbsp;So, with help from friends and colleagues, I decided that we should build our own. &nbsp;Today's post gives a quick overview of its design and then I'll present some measurements of its performance. &nbsp;Were we successful? &nbsp;Were we able to get better dynamic range? &nbsp;Let's find out...<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-6Pbu0oaygzs/WMhFxsrBkbI/AAAAAAAAEMs/8RxOegf6xYYhUgdf5kafvUGLioqpVxYjwCLcB/s1600/TympanSelfNoiseLeadPic.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="250" src="https://1.bp.blogspot.com/-6Pbu0oaygzs/WMhFxsrBkbI/AAAAAAAAEMs/8RxOegf6xYYhUgdf5kafvUGLioqpVxYjwCLcB/s400/TympanSelfNoiseLeadPic.png" width="400" /></a></div><br /><u>The Audio Codec is the Heart</u>: &nbsp;The picture above shows the Tympan audio interface. &nbsp;The heart of the board is the audio codec at the top-center. &nbsp;An audio codec is a highly-integrated chip that, among other duties, does all of the amplification and digitization of the incoming analog audio signals. &nbsp;Choosing the right codec and then properly designing the circuit board around it are both key elements to achieving a low-noise design with maximum dynamic range. <br /><br /><u>Choosing an Audio Codec:</u>&nbsp; The Teensy Audio Board uses the SGTL5000 audio codec. &nbsp;Presumably it was chosen because it is small, low-cost, low-power, and has a built-in headphone driver. &nbsp;For my Tympan audio interface, I want all these same features, but I also want it to be quieter. &nbsp;After looking at a bunch of options, and after talking with colleagues who have experience with a variety of TI parts, we chose to go with the Texas Instruments TLV320AIC3206 (product page <a href="http://www.ti.com/product/TLV320AIC3206">here</a>). &nbsp;It's got many of the same features as the SGTL5000 but promises better audio performance, though at the cost of a few extra bucks per chip. &nbsp;If it gets me the wider dynamic range that I want, I'll be very happy with that trade-off.<br /><br /><u>Circuit Design:</u>&nbsp; Like with the SGTL5000 on the Teensy Audio Board, the TI 3206 needs both the I2C and I2S buses to communicate with the host processor (the host processor being a Teensy 3.5 or 3.6). &nbsp;Also like the Teensy Audio Board, we will run the TI 3206 in "slave" mode, where all clocking is provided by the host processor. &nbsp;In other words, our connections to the TI 3206 parallel the connections used by the SGTL5000. &nbsp;Therefore, in designing our Tympan circuit, the schematic for the Teensy Audio Board was a great help. &nbsp;Yay for open source! &nbsp;And, to continue the sharing, our own schematic is available on the Tympan GitHub <a href="https://github.com/Tympan/Tympan_Library/tree/master/hardware/Tympan_PCB">here</a>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-1TlVW-wxzxE/WMhPU6OUzMI/AAAAAAAAENM/mwo-QYkbpYUxMMVqmoz1D-maPE7WsPkUACLcB/s1600/TympanSchematicRevB.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="255" src="https://1.bp.blogspot.com/-1TlVW-wxzxE/WMhPU6OUzMI/AAAAAAAAENM/mwo-QYkbpYUxMMVqmoz1D-maPE7WsPkUACLcB/s400/TympanSchematicRevB.png" width="400" /></a></div><br /><u>Software Driver:</u>&nbsp; After laying out the PCB and getting it fabricated, we had to write software to allow the Teensy and the TI 3206 to talk to each other. &nbsp;Since I wanted to fit within the Teensy Audio ecosystem, we needed to write a "AudioControl" module that configures the TI 3206 to be in the proper I2S mode so that Teensy's existing I2S functions can successfully transfer audio data to and from the codec. &nbsp;Luckily, I've got a buddy (Brendan, of <a href="http://www.flexvoltbiosensor.com/">FlexVolt</a> fame!) who dived in and figured it all out. &nbsp;His Arduino/Teensy compatible "AudioControl" module is now on the Tympan GitHub (h-file is <a href="https://github.com/Tympan/Tympan_Library/blob/master/control_tlv320aic3206.h">here</a>, cpp file is <a href="https://github.com/Tympan/Tympan_Library/blob/master/control_tlv320aic3206.cpp">here</a>). &nbsp;Thanks, Brendan!<br /><br /><u>Measuring the Self Noise:</u>&nbsp; Once Brendan got the software side of things working [and, in the process, finding errors in the Tympan design -- we erroneously swapped "DIN" and "DOUT" by accident! &nbsp;Oops! &nbsp;The schematic above has been corrected.], I turned my attention to measuring the new system's audio performance. &nbsp;My primary concern was the noise floor of the new hardware. &nbsp;Was it better than the Teensy Audio Board? &nbsp;To find out, I used a raw 3.5 mm stereo plug in the Tympan's input jack and shorted both the left and right inputs to ground. &nbsp;Now, when I start recording, I should only see the Tympan's own self-noise.<br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-MYgkqc-Evrw/WMhOOUDzYzI/AAAAAAAAENE/UadVJgsfbcUaq0oqTCKezcmpatvBen9fwCLcB/s1600/ShortingTheInputs.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="275" src="https://2.bp.blogspot.com/-MYgkqc-Evrw/WMhOOUDzYzI/AAAAAAAAENE/UadVJgsfbcUaq0oqTCKezcmpatvBen9fwCLcB/s400/ShortingTheInputs.png" width="400" /></a></div><u><br /></u><u>Arduino Sketch</u>: &nbsp;Now I need some software to do the actual recording. &nbsp;So, starting from the Arduino sketch used to record the noise for the Teensy Audio Board (<a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2017-03-11%20Teensy%20and%20Tympan%20Self%20Noise/Arduino/Teensy_VaryInputGain_USB">here</a>), I swapped it over to use the Tympan audio board instead of the Teensy audio board (new version&nbsp;<a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2017-03-11%20Teensy%20and%20Tympan%20Self%20Noise/Arduino/Teensy_VaryInputGain_USB">here</a>). &nbsp;This sketch digitizes the input audio (which has been shorted to ground) and sends the digital samples over USB to be recorded on the PC.<br /><br /><u>Results, USB Audio:</u>&nbsp; With the inputs shorted on my Tympan board, and with me recording the audio via USB in Audacity (as discussed <a href="http://openaudio.blogspot.com/2016/10/teensy-audio-over-usb.html">here</a>), I recorded the self-noise of the Tympan. &nbsp;The spectrum of the self-noise is shown below. &nbsp;It's a pretty flat spectrum, which is always nice to see. &nbsp;The only unexpected feature is the increase in the noise seen at the highest frequencies. &nbsp; What is that?<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-tAgoQDfHqro/WMhiln9ayVI/AAAAAAAAEOA/4mgGQ4yWLcQv9kCd3-xoNCPwxHPgSL9VwCLcB/s1600/Spectrum-USB.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="271" src="https://1.bp.blogspot.com/-tAgoQDfHqro/WMhiln9ayVI/AAAAAAAAEOA/4mgGQ4yWLcQv9kCd3-xoNCPwxHPgSL9VwCLcB/s400/Spectrum-USB.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">It's a pretty nice spectrum, except for the bump up at the high frequencies. &nbsp;What's that?!?</td></tr></tbody></table><u>USB vs SD:</u>&nbsp; The recording above was taken via USB. &nbsp;Therefore, the USB cable was attached to the Teensy/Tympan. &nbsp;USB cables are notorious for injecting noise. &nbsp;Frankly, I surprised that the spectrum shown above is as low and as flat as it is. &nbsp;To see if the USB connection was the cause in the bump at the higher frequencies, I revised the sketch to record the audio to the Teensy's SD card instead of sending it over USB (new sketch is <a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2017-03-11%20Teensy%20and%20Tympan%20Self%20Noise/Arduino/Tympan_VaryInputGain_SD">here</a>), &nbsp;Re-running my test, I see that the high-frequency hump is gone! &nbsp;Now that's a beautifully flat spectrum...<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-vg4I3e3M18A/WMhio4vR3SI/AAAAAAAAEOE/AMMcorAfP6IBFnxJDB674mGhl4VtP2_FACLcB/s1600/Spectrum-SD.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="278" src="https://4.bp.blogspot.com/-vg4I3e3M18A/WMhio4vR3SI/AAAAAAAAEOE/AMMcorAfP6IBFnxJDB674mGhl4VtP2_FACLcB/s400/Spectrum-SD.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">By disconnecting the USB cable and recording the audio via SD card, the bump in the spectrum goes away. &nbsp;Now the self-noise is nice and flat. &nbsp;Excellent.</td></tr></tbody></table><u>Noise Floor Comparison:</u>&nbsp; My primary goal for the Tympan board was to have a lower the noise floor (and thereby increase the dynamic range) than I saw with the Teensy Audio Board. &nbsp;To see if I was successful, I used my recordings to compute the total self-noise across the frequency range of 125-8000 Hz. This is the frequency range most relevant for my hearing aid work. &nbsp;I assessed this broadband self-noise value for the Teensy and Tympan boards across a range of analog gain settings. &nbsp;The result of this noise analysis is shown in the figure below.<br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-6E5eSdi3qxg/WMhleh3xZyI/AAAAAAAAEOQ/7eI-iDMlzOgvVWFKGRXQLMY0sD7g71RJACLcB/s1600/CompareNoiseLevels.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="252" src="https://2.bp.blogspot.com/-6E5eSdi3qxg/WMhleh3xZyI/AAAAAAAAEOQ/7eI-iDMlzOgvVWFKGRXQLMY0sD7g71RJACLcB/s400/CompareNoiseLevels.png" width="400" /></a></div><u>Apples-to-Apples:</u>&nbsp; The Teensy and Tympan boards have different ways of specifying the input gain. &nbsp;Ideally, I'd be able to set the same amount of gain for each board, but that wasn't possible. &nbsp;So, to &nbsp;align the data in the most fair way, you can see that plot the values as function of the "maximum allowed input signal". &nbsp;As expected, increasing the gain decreases the max allowed input. &nbsp;So, at any given value for max allowed input, it is a fair to compare between the two systems. &nbsp;As can be seen, the Tympan audio board does indeed have lower noise than the Teensy audio board.<br /><br /><u>Dynamic Range Comparison:</u>&nbsp; Another way to express this same data is to show the dynamic range of the system. &nbsp;The dynamic range is the difference between the max allowed input signal and the system's noise floor. &nbsp;I want as wide a dynamic range as possible, so as to better mimic the human ear. &nbsp;As can be seen below, the Tympan audio board does indeed provide greater dynamic range than the Teensy audio board. &nbsp;Specifically, the Tympan is getting 92.4-94.6 dB of dynamic range (in the 125-8000 Hz band) versus 80-81 dB for the Teensy Audio Board. &nbsp;This is quite an improvement!<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-y2wWMnlOHZo/WMhlkX4k0KI/AAAAAAAAEOU/42Ilklwbz70osCNd98Fj4pefBGQmt4FhACLcB/s1600/CompareDynamicRange.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="255" src="https://2.bp.blogspot.com/-y2wWMnlOHZo/WMhlkX4k0KI/AAAAAAAAEOU/42Ilklwbz70osCNd98Fj4pefBGQmt4FhACLcB/s400/CompareDynamicRange.png" width="400" /></a></div><u>Keeping Perspective:</u>&nbsp; While I am very pleased with the performance of the TI 3206 on the Tympan audio board, it's important to remember that the Teensy audio board has some significant advantages in other areas. &nbsp;First, you can go buy your own Teensy Audio Board right now, whereas you can't (yet) get a Tympan. &nbsp;Second, the Teensy Audio Board is remarkably inexpensive. &nbsp;It's hard to see the Tympan board ever being that inexpensive. &nbsp;Yes, PJRC did a fantastic job making a good piece of hardware at a fantastic price. &nbsp;That's for sure.<br /><br /><u>Next Steps:</u>&nbsp; I'm going to use the Tympan as a platform for open source hearing aid experiments. &nbsp;But, a hearing aid is more than just electronics. &nbsp;So, my next steps are to start adding in other elements like microphones and earphones. &nbsp;And, I have to get back to making audio processing algorithms! &nbsp;That's where the fun really happens!<br /><br />
