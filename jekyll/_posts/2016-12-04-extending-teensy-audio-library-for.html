---
layout: post
title: Extending Teensy Audio Library for Floating-Point
author: Chip
---


For my <a href="http://openaudio.blogspot.com/2016/11/a-teensy-hearing-aid.html">Teensy-based hearing aid</a>, it will be much easier to program new audio processing algorithms if I can use floating-point aido data instead of fixed-point audio data. &nbsp;Unfortunately, the Teensy Audio Library assumes the use fixed-point data types (ie, Int16) for all of its processing blocks. &nbsp;So, I decided to extend that library to enable the floating-point processing that I want. &nbsp;Here's an overview of how I made it work. &nbsp;My "OpenAudio" library is available on my GitHub <a href="https://github.com/chipaudette/OpenAudio_ArduinoLibrary">here</a>. &nbsp;I'd love any feedback (or GitHub pull requests!) on how it could be done better.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-MvDIFbOe4MQ/WEM-AaCiYZI/AAAAAAAAEEs/Fzu7exZD7gw7AP7pfTl1rU0Ykp9mQbNFwCLcB/s1600/LibraryExtension.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="335" src="https://1.bp.blogspot.com/-MvDIFbOe4MQ/WEM-AaCiYZI/AAAAAAAAEEs/Fzu7exZD7gw7AP7pfTl1rU0Ykp9mQbNFwCLcB/s400/LibraryExtension.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><u>Teensy Audio Library Assumes Int16:</u>&nbsp; My goal has been to maintain as much of the Teensy Audio Library's structure as possible. &nbsp;But, many of the core elements of the Teensy Audio Library are deeply entwined with the assumption of fixed-point Int16 audio data. &nbsp;Shown in red in the figure above are several of the foundational elements of the Teensy Audio Library that are tied to Int16 audio data. &nbsp;These are the elements that I extended.<br /><br /><u>OpenAudio F32 Versions:</u>&nbsp; To enable Float32 operations, I wrote new Float32 versions of these elements. &nbsp;I used inheritance where possible to reduce the duplication of functionality, particularly for the AudioStream to AudioStream_F32 conversion. &nbsp;To maintain the structure and conventions of the Teensy Audio Library, I made a one-for-one replacement so that one only need to substitute the "<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">_F32</span>" version for the standard version.<br /><br /><u>Conversion Routines:</u>&nbsp; To interface between the Int16 data of the Teensy Audio Library and the Float32 data used my extended library, I also wrote two new "<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioConvert</span>" classes. &nbsp;In addition to converting between the Int16 and Float32 data types, these routines also re-scale the data. &nbsp;The Teensy Audio Library assumes "full scale" is ±32768 whereas my floating-point objects assume that ±1.0 is full scale. &nbsp;My conversion routines automatically account for this difference.<br /><br /><u>OpenAudio F32 Example:</u>&nbsp; If you download the library and unzip it into your Arduino Libraries directory (see "Installation" notes&nbsp;<a href="https://github.com/chipaudette/OpenAudio_ArduinoLibrary/blob/master/readme.md">here</a>), you can start the Arduino IDE and load an example sketch that comes with the library. &nbsp;Go under the "File" menu and select "Examples", then, "OpenAudio_ArduinoLibrary", then "BasicGain_Float".<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-m5f4ZGKg5pw/WEM6ARN-BAI/AAAAAAAAEEc/IAby6zgbSTcAa2Dr4hmqlBYV2bh6eD13QCEw/s1600/Screenshot_examples.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="390" src="https://4.bp.blogspot.com/-m5f4ZGKg5pw/WEM6ARN-BAI/AAAAAAAAEEc/IAby6zgbSTcAa2Dr4hmqlBYV2bh6eD13QCEw/s400/Screenshot_examples.png" width="400" /></a></div><br /><u>Add a New <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#include</span>:</u>&nbsp; Inside this sketch, you'll see many features that are similar to every sketch that uses the Teensy Audio Library. &nbsp;For example, the screenshot below shows the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#include</span> statements at the beginning of the sketch. &nbsp;Note that I added an&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#include</span> for the new OpenAudio library. &nbsp;Once this line is added, any of the new OpenAudio classes can be used.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-jGA7f6f2cZE/WEQ0tN5-j9I/AAAAAAAAEFM/X-8j0HRgUOU5obAj4Lmc0wi_kjbG5si5gCEw/s1600/Screenshot_basicgain_01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="146" src="https://2.bp.blogspot.com/-jGA7f6f2cZE/WEQ0tN5-j9I/AAAAAAAAEFM/X-8j0HRgUOU5obAj4Lmc0wi_kjbG5si5gCEw/s400/Screenshot_basicgain_01.png" width="400" /></a></div><br /><u>Instantiate the New Classes</u>: &nbsp;In a typical sketch using the Teensy Audio Library, the next block of code instantiates the audio-related objects. &nbsp;The screenshot below illustrates this by invoking the standard <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioControlSGTL5000</span>, <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioInputI2S</span>, and <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioOutputI2S</span> classes. &nbsp; After these standard lines, I added three new lines that instantiate blocks for floating-point processing.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-T1yUwhXFwjk/WEQ0tMg6UoI/AAAAAAAAEFQ/r8bEj4gcrrgfLOonOWHSkPacHid6mR5FwCEw/s1600/Screenshot_basicgain_02.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="136" src="https://3.bp.blogspot.com/-T1yUwhXFwjk/WEQ0tMg6UoI/AAAAAAAAEFQ/r8bEj4gcrrgfLOonOWHSkPacHid6mR5FwCEw/s400/Screenshot_basicgain_02.png" width="400" /></a></div><br />In this case,&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioConvert_I16toF32 </span>will convert the standard Int16 audio data to float32. &nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioEffectGain_F32</span> will apply gain to the float32 audio data. &nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioConvert_F32toI16</span> will convert the audio data back to Int16 so that it can be output by the usual functions of the Teensy Audio Library.<br /><br /><u>New Audio Connections:</u>&nbsp; After instantiating the objects, the next step is to make the audio connections between the objects. &nbsp;The screenshot below shows that a mix of standard (Int16) connections and new (Float32) connections are used to make the full processing chain. &nbsp;The standard connections (<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioConnection</span>) are used whenever the data being passed is Int16 data. &nbsp;The new connections (<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">AudioConnection_F32</span>) are used whenever the data is float32 data.<br /><div><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-BJWsPiRRbR8/WEQ0tBcgOAI/AAAAAAAAEFU/ptA5AMRIFPIjVs4sz6sPYfWX1WExONmmACEw/s1600/Screenshot_basicgain_03.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="167" src="https://3.bp.blogspot.com/-BJWsPiRRbR8/WEQ0tBcgOAI/AAAAAAAAEFU/ptA5AMRIFPIjVs4sz6sPYfWX1WExONmmACEw/s400/Screenshot_basicgain_03.png" width="400" /></a></div><br /><u>Allocate Float32 Memory:</u>&nbsp; The last step is shown in the screenshot below. &nbsp;In the setup() function is where memory is allocated for the Teensy Audio Library via the AudioMemory() statement. &nbsp;Following this same pattern, I added the AudioMemory_F32() statement to allocate the float32 memory that is needed for the floating-point processing.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-2qygIjMHexg/WEQ0tSabQVI/AAAAAAAAEFY/6fvki-CmFsQMjEw5DLtiuCuQGrDixGXagCEw/s1600/Screenshot_basicgain_04.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="163" src="https://2.bp.blogspot.com/-2qygIjMHexg/WEQ0tSabQVI/AAAAAAAAEFY/6fvki-CmFsQMjEw5DLtiuCuQGrDixGXagCEw/s400/Screenshot_basicgain_04.png" width="400" /></a></div><br /><u>Complie and Run:</u>&nbsp; If you have a Teensy 3.5 or 3.6 and a Teensy Audio Board, you can compile and run this example sketch. &nbsp;If you have a potentiometer attached to the Teensy Audio Board's volume control, you can use the pot to adjust the volume of the sound (well, it actually adjusts the gain applied by the new floating-point gain block). &nbsp;On my hardware, it works great! &nbsp;Hopefully it works well on yours, too.<br /><br /><u>Next Steps:</u>&nbsp; With the floating-point audio processing structure in-place, I can move forward with adding more "F32" processing blocks for the different functions that I need. &nbsp;My next block will be a dynamic range compressor. &nbsp;Then I'll probably add a filtering block. &nbsp;Eventually, I'll be looking to add frequency-domain processing, which will likely involve extending my library again for a "complex_float32" data type. &nbsp;That'll be even more fun!<br /><br /><u>Update:</u>&nbsp; I had my first Pull Request with <a href="http://openaudio.blogspot.com/2017/01/received-my-first-pull-request.html">a user contribution</a>. &nbsp;So awesome!<br /><u>Update:</u>&nbsp; I've added an algorithms: a basic <a href="http://openaudio.blogspot.com/2017/01/basic-dynamic-range-compressor.html">Dynamic Range Compressor</a>.</div>
