---
layout: post
title: For Speedy Float Math, Specify the Float Version
author: Chip
image: https://1.bp.blogspot.com/-6PylC4XMY88/WJvWO6ODYTI/AAAAAAAAEJo/vMYH8ZTqZIoXZDJQmA68nB55YBIkeUGbwCLcB/s640/Plot_GeneralVsFloat.png
---


When programming up my audio processing algorithms on the Teensy 3.6, I sometimes find that the math operations are much slower than I was expecting. &nbsp;Yes, some things are super-fast: arithmetic, FIR filters, <a href="http://openaudio.blogspot.com/2016/10/benchmarking-teensy-36-is-fast.html">FFT</a>. &nbsp;But did my code with the logarithm run so slowly? &nbsp;Well, it turns out that I was using the wrong function call. &nbsp;If you use the float-specific version of your function, you get tremendously faster floating-point speeds. &nbsp;Don't rely on the compiler; be explicit and call it yourself!<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-6PylC4XMY88/WJvWO6ODYTI/AAAAAAAAEJo/vMYH8ZTqZIoXZDJQmA68nB55YBIkeUGbwCLcB/s1600/Plot_GeneralVsFloat.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="314" src="https://1.bp.blogspot.com/-6PylC4XMY88/WJvWO6ODYTI/AAAAAAAAEJo/vMYH8ZTqZIoXZDJQmA68nB55YBIkeUGbwCLcB/s640/Plot_GeneralVsFloat.png" width="540" /></a></div>As you can see in the graph above, I measured how long it took to complete several different math functions when using floating-point data. &nbsp;The interesting part is that each math function can be called in two different ways: (1) using its generic form such as sqrt(x) or (2) using its explicitly floating-point form such as sqrtf(x). &nbsp;In all cases, the explicit floating-point form was <u>much</u> faster. <br /><br />Being a Matlab programmer, my fingers generally type out the generic form of the function. &nbsp;Being naive, I had assumed that the compiler would detect my data type and automatically substitute the exact same floating-point function that I would have called myself. &nbsp;Apparently, I was wrong. &nbsp;Way wrong.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-r9Kfgedim3E/WJvbJqWJUeI/AAAAAAAAEJ4/wv7P4VeKuIwKHHpjsgLJmKu02I6JVVCeQCLcB/s1600/Table_float_versions.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="134" src="https://2.bp.blogspot.com/-r9Kfgedim3E/WJvbJqWJUeI/AAAAAAAAEJ4/wv7P4VeKuIwKHHpjsgLJmKu02I6JVVCeQCLcB/s640/Table_float_versions.png" width="480" /></a></div>The table above shows that the square root function benefits the most when using the explicitly floating-point form. &nbsp;The explicitly floating-point version is over 30 times faster! &nbsp;The Teensy (well, every ARM M4F) has hardware acceleration for doing square roots. &nbsp;I'm guessing the sqrt(x) form does not use the acceleration whereas the sqrtf(x) form does. &nbsp;30x is a huge large increase in speed.<br /><br />Interestingly, the logarithm and exponential/power functions do not have hardware acceleration in the Teensy. &nbsp;Yet, when using the explicitly floating-point version, they see a 10x increase in speed. &nbsp;Stunning.<br /><br />Why are the explicitly floating-point versions so much faster? &nbsp;I don't know. &nbsp;But I sure as heck am going to make sure that all my future code uses them.<br /><br /><i>Tech Info: This data was measured using a Teensy 3.6 running at 180 MHz. &nbsp;It was programmed from the Arduino IDE (1.6.13) via the Teensyduino (1.35) add-on. &nbsp;My code is on my GitHub&nbsp;<a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2017-02-07%20Faster%20Float%20Functions/SpeedOfFloatFunctions">here</a>.</i><br /><i><br /></i>Follow-Up: &nbsp;Why is the float-specific version ("logf()") so much faster than generic version ("log()")? &nbsp;I posted this to the Teensy Forum. &nbsp;Their replies (<a href="https://forum.pjrc.com/threads/36788-Audio-Processing-Benchmarking-on-Teensy-3-2-and-K66-(Teensy-3-6)?p=133168&amp;viewfull=1#post133168">here</a>) were pretty definitive. &nbsp;Under the hood, the generic version (ie, "log()") will do the calculations as double-precision floating point math, which is all in software. &nbsp;By contrasts, the floating-point version ("logf()") is for single-precision floating point math, which on the Teensy is done with hardware acceleration. &nbsp;That explains why the float-specific version is so much faster.
