---
layout: post
title: Calibrating Microphones with Tympan
author: Chip
image: https://1.bp.blogspot.com/-osjh6QV2PeQ/WSF-uqX6QLI/AAAAAAAAERM/n2JNwIMXteQkE7z4R5d_yEPjXjrOo-_XgCLcB/s400/three%2Bmics.png
---


One goal of our open source hearing aid platform ("Tympan") is to get people to experiment both with new sound processing algorithms but also to experiment with different microphones and speakers. &nbsp;So, with regards to microphones, we designed the Tympan electronics to have several different kinds of inputs to allow it to support a range of microphones. &nbsp;Today, I'll start by calibrating three different microphones with the Tympan. &nbsp;Then, in a later post, I'll look at how the different microphones influence the self-noise of the system.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-osjh6QV2PeQ/WSF-uqX6QLI/AAAAAAAAERM/n2JNwIMXteQkE7z4R5d_yEPjXjrOo-_XgCLcB/s1600/three%2Bmics.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="212" src="https://1.bp.blogspot.com/-osjh6QV2PeQ/WSF-uqX6QLI/AAAAAAAAERM/n2JNwIMXteQkE7z4R5d_yEPjXjrOo-_XgCLcB/s400/three%2Bmics.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><u>Microphones:</u>&nbsp; The three microphones that I'm using today are shown above. &nbsp;There's the "Sony Mic", which &nbsp;is a lapel electret mic intended for picking up voice. &nbsp;Then, there is the "PCB Mic", which is an inexpensive surface-mount silicon MEMS mic that we've included on the Tympan PCB. &nbsp;And, finally, there's the "Knowles Mic", which is a high-sensitivity, low-noise mic intended for use in hearing instruments like hearing aids.<br /><br /><u>Why Calibrate?</u>&nbsp; If you calibrate your microphones, your audio processing will be able to look at the in-coming digital data and know what sound level is happening in the real world. &nbsp;Knowing the true sound level in the different frequency bands allows you to tailor your algorithms (amplification, compression, noise reduction) to better respond to a person's specific hearing loss.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-5KGwfnudxW8/WSD4Uby1TkI/AAAAAAAAEQg/VP91E7ygbWAbZqBG9sW1i7jKzAUa3u_NwCLcB/s1600/Schematic%2Bof%2BSetup.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="233" src="https://2.bp.blogspot.com/-5KGwfnudxW8/WSD4Uby1TkI/AAAAAAAAEQg/VP91E7ygbWAbZqBG9sW1i7jKzAUa3u_NwCLcB/s400/Schematic%2Bof%2BSetup.png" width="400" /></a></div><u>Calibration Approach:</u>&nbsp; To calibrate these microphones, I'm using the approach shown above. &nbsp;Here, I put the Tympan in my sound chamber and play known sounds at it. &nbsp;I record the digital values obtained by the Tympan (recorded via its SD card) and compare them to the "truth" that was simultaneously recorded from my laboratory-grade microphone (Bruel &amp; Kjaer 4191).<br /><u><br /></u><u>Truth Microphone:</u>&nbsp; It is important that the truth microphone be placed very close to the Tympan microphone during this calibration. &nbsp;Ideally, they'll see exactly the same sound levels. &nbsp;Pictures showing my arrangement is shown below.<br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-oJDA7tS5pUw/WSGDxLLmy0I/AAAAAAAAERc/rRtJepzqEB8mksTTwDbewA0tUJWo9g23QCLcB/s1600/Mics%2Bwith%2BTruth%2BMic.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="233" src="https://2.bp.blogspot.com/-oJDA7tS5pUw/WSGDxLLmy0I/AAAAAAAAERc/rRtJepzqEB8mksTTwDbewA0tUJWo9g23QCLcB/s640/Mics%2Bwith%2BTruth%2BMic.png" width="540" /></a></div><u>Connecting the Tympan Microphone:</u>&nbsp; Each of the three test microphones connects to the Tympan in a different way:<br /><ul><li>Sony Mic: &nbsp;Like many lapel microphones, this mic comes nicely packaged with a 1/8" (3.5 mm) phono plug. &nbsp;We have a mic jack on the Tympan PCB just for this purpose! &nbsp;I programmed the Typman to supply a 2.5V bias voltage for this microphone. &nbsp;</li><li>PCB Mic: This microphone is just a raw element. &nbsp;We designed the Tympan to have two of these mics right on the circuit board so that they'd be easy to use. &nbsp;Therefore, this mic is already wired and simply needs to be enabled in the Tympan software. &nbsp;</li><li>Knowles Mic: This is a raw hearing aid microphone. &nbsp;I soldered some wires to it and connected the wires to the Tympan's "line in" holes that are on the edge of the Tympan PCB. &nbsp;I provided the bias voltage from a pair of AA alkaline batteries.</li></ul><u>Software:</u>&nbsp; For this test, I wrote an Arduino sketch that allows me to switch the Tympan between the three different microphones. &nbsp;The sketch saves the digitized audio to the Teensy's SD card. &nbsp;Additionally, the sketch steps through different levels of gain on the Tympan input (0 dB to&nbsp;+40 dB) so that I can see its effect. &nbsp;My Arduino code is on my GitHub <a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2017-05-21%20Calibrating%20Mics/Arduino/Tympan_VaryInputGain_SD">here</a>. &nbsp;You'll also need the Tympan library, which you can get <a href="https://github.com/Tympan/Tympan_Library">here</a>.<br /><br /><u>Example Data:</u>&nbsp; Below is a spectrogram of the audio data that I recorded during one of these calibration tests. &nbsp;The top plot shows the audio from the truth microphone. &nbsp;The bottom plot is the signal recorded by the Tympan, in this case for the Sony mic. &nbsp;You can see that I had a loop of audio that I was playing over-and-over into the room. &nbsp;The audio loop alternates between white noise and a 1 kHz test tone. &nbsp;In the bottom plot, you can clearly the see the effect of increasing the gain of the Tympan input.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-8sCeNT2kah0/WSD4z87f4EI/AAAAAAAAEQs/PUFi0-AHz2800q6FyAShnv_D_fWDclczwCLcB/s1600/Spectrogram%2Bof%2BRaw%2BData.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://1.bp.blogspot.com/-8sCeNT2kah0/WSD4z87f4EI/AAAAAAAAEQs/PUFi0-AHz2800q6FyAShnv_D_fWDclczwCLcB/s640/Spectrogram%2Bof%2BRaw%2BData.png" width="540" /></a></div><u>Analyzing&nbsp;the Truth Data:</u>&nbsp; I started by analyzing the truth data. &nbsp;Looking at just the white noise periods, I filtered the audio into 3rd-octave bands from 125 Hz to 16 kHz and assessed the average signal level in each band. &nbsp;Because this laboratory microphone is itself regularly calibrated, I know its data in units of Pascals, which leads directly to units of sound pressure level (SPL). &nbsp;The SPL that I measured in each band is shown in the figure below. &nbsp;This is the truth to which I will compare the Tympan data.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-Me3I9-4JhNE/WSD5B5bHmlI/AAAAAAAAEQw/JVwWocuGkBowIJRFz9cjQsIjS7k5DpNpQCEw/s1600/Spectrum%2Bof%2BTruth%2BMic.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="186" src="https://3.bp.blogspot.com/-Me3I9-4JhNE/WSD5B5bHmlI/AAAAAAAAEQw/JVwWocuGkBowIJRFz9cjQsIjS7k5DpNpQCEw/s320/Spectrum%2Bof%2BTruth%2BMic.png" width="320" /></a></div><u>Analyzing the Tympan Data:</u>&nbsp; I performed the same 3rd-octave band analysis of the Tympan data. &nbsp;Because this microphone is not calibrated (that's what we're doing here) I can only measure the signal levels relative to digital full scale (ie, relative to the level at which the system starts to digitally clip the data). &nbsp;The plot below shows the 3rd-octave band levels that I measured for the Tympan for the five different gain settings. &nbsp;The blue line at the bottom shows the levels when the input gain was set to 0 dB while the green line at the top is for an input gain of&nbsp;+40 dB.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-mw7JvB23qhI/WSD5HITL56I/AAAAAAAAEQ0/eSjpUB4SPL8zP1gvVeO6BmcsBccrNPKxACLcB/s1600/Spectrum%2Bof%2BSony%2BMic.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="178" src="https://1.bp.blogspot.com/-mw7JvB23qhI/WSD5HITL56I/AAAAAAAAEQ0/eSjpUB4SPL8zP1gvVeO6BmcsBccrNPKxACLcB/s320/Spectrum%2Bof%2BSony%2BMic.png" width="320" /></a></div><u>Combining with the Truth:</u>&nbsp; The last step to computing the scale factor is to combine the Tympan data with the truth data. &nbsp;By bringing the two sets of data together, I can compute how the Tympan digital values (dBFS) can be scaled to reveal the true, in-the-air sound pressure level (SPL). &nbsp;The figure below shows the resulting scale factor for the Sony mic for the different Tympan gain settings. &nbsp;It is good to see that the gain setting only appears to affect the overall sensitivity of the system -- that the shape of the frequency response is basically the same for all gain settings.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Kyykioh2Kn8/WSD5Kq9yLCI/AAAAAAAAEQ4/FsKTRoGW2bwSEHknbm1qUAAfxZ-H2MLDQCLcB/s1600/Scale%2BFactor%2Bfor%2BSony%2BMic.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="172" src="https://1.bp.blogspot.com/-Kyykioh2Kn8/WSD5Kq9yLCI/AAAAAAAAEQ4/FsKTRoGW2bwSEHknbm1qUAAfxZ-H2MLDQCLcB/s400/Scale%2BFactor%2Bfor%2BSony%2BMic.png" width="400" /></a></div><u>Repeat for Other Mics:</u>&nbsp; When I perform this calibration process for all of the microphones, I get the figure below. &nbsp;It shows that the Sony mic (blue) has a up-sloping response, which is good for a closely-placed lapel microphone. &nbsp;The PCB mic (orange) is more flat, but has nearly the same sensitivity as the Sony mic. &nbsp;The most interesting response is the Knowles mic (yellow) because it is nearly 20 dB more sensitive than the other two. &nbsp;That is quite a difference!<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-FUfEe0_xF9I/WSD5Pe51A9I/AAAAAAAAEQ8/nwoDkR-MmQU_TZHLwMXNUzyDPZlt5l3tQCLcB/s1600/Calibration%2Bfor%2BAll%2BMics.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="220" src="https://1.bp.blogspot.com/-FUfEe0_xF9I/WSD5Pe51A9I/AAAAAAAAEQ8/nwoDkR-MmQU_TZHLwMXNUzyDPZlt5l3tQCLcB/s320/Calibration%2Bfor%2BAll%2BMics.png" width="320" /></a></div><u>What Gain Setting to Use?</u>&nbsp; In my tests, I tried a bunch of different gain settings. &nbsp;Which is the right one to use? &nbsp;Well, one approach to picking the right gain is to decide what is loudest sound that is likely to be seen. &nbsp;Let's assume that 120 dB SPL is the loudest sound that we want the Tympan to handle &nbsp;Then, we look at our sensitivity numbers and choose a gain setting that permits this maximum SPL without clipping. &nbsp;Using the data for the graph above, the calculation goes like this:<br /><br /><ul><li>Sony Mic at 120 dB SPL yields a digital level of: (120-94)&nbsp;+ -48.6 = -22.6 dBFS. &nbsp;This means that it has 22.6 dB of excess headroom. &nbsp;I can safely set the gain to&nbsp;<b>+20 dB.</b></li><li>PCB Mic at 120 dB SPL yields a digital level of: (120-94)&nbsp;+ -47.4 = -21.4 dBFS. &nbsp;This means that it has 21.4 dB of excess headroom. &nbsp;I can safely set the gain to&nbsp;<b>+20 dB</b>.</li><li>Knowles Mic at 120 dB SPL yields a digital level of; (120-94)&nbsp;+ -28.9 = -2.9 dBFS. &nbsp;This means that it only has 2.9 dB of headroom. &nbsp;For this mic, I would leave the gain at <b>0 dB</b>.&nbsp;</li></ul><div><u>We're Calibrated!</u>&nbsp; With this testing, we've now calibrated these three microphones with the Tympan. &nbsp;We know the frequency response and we know how to relate our recorded digital values to real-world SPL numbers. &nbsp;We also have some guidance as to what gain value we should use for each microphone. &nbsp;We got a lot done!</div><div><br /><u>Follow-Up:</u>&nbsp; I've added the raw data and my Matlab analysis files to my GitHub repo. &nbsp;You can get them <a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2017-05-21%20Calibrating%20Mics">here</a>.</div>
