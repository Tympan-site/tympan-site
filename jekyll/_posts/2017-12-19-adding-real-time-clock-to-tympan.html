---
layout: post
title: Adding a Real Time Clock to the Tympan
author: Chip
image: https://4.bp.blogspot.com/-6BOdDC50Qkw/Wjkzm99eYxI/AAAAAAAAEVw/dXhM1ywiheEHaKPK-H6RHIXPJgB95BwxQCLcBGAs/s400/Teensy%2Bin%2BEnclosure.png
---


In talking with users of the Tympan, data logging is something that they'd like the Tympan to do.&nbsp; Furthermore, for the data logging to be useful, the data needs to be time stamped.&nbsp; So, the Tympan needs to know the time and date.&nbsp; Normally, one needs to add a dedicated real-time clock (RTC) circuit for a device to know the time and date.&nbsp; Luckily, the Teensy 3.6 that is at the heart of the Tympan has most of the required elements already built in.&nbsp; Let's finish it off to make it work!<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-6BOdDC50Qkw/Wjkzm99eYxI/AAAAAAAAEVw/dXhM1ywiheEHaKPK-H6RHIXPJgB95BwxQCLcBGAs/s1600/Teensy%2Bin%2BEnclosure.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="570" data-original-width="854" height="266" src="https://4.bp.blogspot.com/-6BOdDC50Qkw/Wjkzm99eYxI/AAAAAAAAEVw/dXhM1ywiheEHaKPK-H6RHIXPJgB95BwxQCLcBGAs/s400/Teensy%2Bin%2BEnclosure.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">My Tympan with the RTC mod.&nbsp; The red wire is the only indication that it has been modified.</td></tr></tbody></table><u>What is a RTC?</u>&nbsp; A real-time clock is a circuit that keeps time despite the device itself being turned on or off.&nbsp; The RTC works because it is usually provided its own power via a small coin cell battery.&nbsp; The Teensy 3.6 includes all the components that we need except for this battery.&nbsp; Normally, you could simply connect a coin cell and you would be done.<br /><br /><u>Use our LiPo Battery Instead of a Coin Cell.</u>&nbsp; For Tympan, I don't want to try to squeeze a coin cell battery into the Tympan's enclosure.&nbsp; We already have a perfectly good battery in the system (the LiPo battery that powers the whole device).&nbsp; Can't we use that battery for the RTC, too?&nbsp; I think that we can.<br /><br /><u>Providing Power, Even When "Off".</u>&nbsp; There are two tricks to using the LiPo battery.&nbsp; First, we need to bring the LiPo power to the RTC circuit on the Teensy even when the Tympan's power switch is set to "off".&nbsp; In other words, we have to be choosy about where we grab the LiPo power when we bring it to the RTC.&nbsp; Second, before we connect the LiPo to the RTC, we need to step down the LiPo voltage (3.7-4.2V) so that it won't damage the RTC (&lt; 3.6V).<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-B1_NCGyQ8Us/Wjk2E5kijvI/AAAAAAAAEWA/M_l19wKoyds5QpcqVC0hYKPAATeJ-yBIwCLcBGAs/s1600/Schematic.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="436" data-original-width="963" height="244" src="https://4.bp.blogspot.com/-B1_NCGyQ8Us/Wjk2E5kijvI/AAAAAAAAEWA/M_l19wKoyds5QpcqVC0hYKPAATeJ-yBIwCLcBGAs/s640/Schematic.png" width="540" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The red arrows show the many choices for where to grap the LiPo power for the Teensy's RTC.&nbsp; I chose to grab the LiPo power from the Fuse F1, as shown by the heavy red arrow.</td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div><u>Choosing the Connection Point.</u>&nbsp; The figure above is an excerpt from the Tympan schematic (full schematic&nbsp;<a href="https://github.com/Tympan/Tympan_Rev_C_Hardware/blob/master/Tympan_C_Schematic.pdf">here</a>).&nbsp; It shows the elements of the circuit related to the LiPo battery (BT1) and the power swtich (SW1).&nbsp; I added red arrows to show all the locations that we could grab the LiPo battery voltage prior to the power switch.&nbsp; Any of these will work.&nbsp; The specific place that we chose will be driven by which spot is easiest to reach with a soldering iron.<br /><br /><u>Stepping Down the Voltage.</u>&nbsp; After choosing place to grab the LiPo power, we need to step down its voltage to a safe level.&nbsp; One can use a variety of techniques.&nbsp; Since the current draw for the RTC is very, very low (about a microamp?), I chose to use a simple voltage divider.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-eszWd9b1rWY/Wjk06RkfyvI/AAAAAAAAEV4/7yogF49IvbY1Ed-jAIBbH7n9UMBYSxnzgCLcBGAs/s1600/VoltageDividerSchem.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="255" data-original-width="537" height="151" src="https://3.bp.blogspot.com/-eszWd9b1rWY/Wjk06RkfyvI/AAAAAAAAEV4/7yogF49IvbY1Ed-jAIBbH7n9UMBYSxnzgCLcBGAs/s320/VoltageDividerSchem.png" width="320" /></a></div><u>Designing the Voltage Divider.</u>&nbsp; According to the datasheet for the Teensy' microprocessor, the voltage at the RTC battery pin needs to be between 1.71V and 3.6V.&nbsp; We need to step down the LiPo voltage to say within these bounds.&nbsp; To decide what resistor values to use, I am going to assume that the LiPo can go down to 3.3V and maybe as high as 5V (which would only happen if I were to make a wiring mistake while hacking).&nbsp; Given these limits, I chose to use a 50K resistor (high side) and a 125K resistor (low side).&nbsp; As can be seen in the graph below, these resistor values mean that the voltage will be good for any RTC current draw up to 10-50 microamps.&nbsp; Looks great!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-1v4yHhZYodc/WjkbM7SMvmI/AAAAAAAAEVI/z18zz4me1LYm-4NXlN1Gu0D5l0iJXlyBgCLcBGAs/s1600/Battery%2BVoltage.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="471" data-original-width="754" height="248" src="https://3.bp.blogspot.com/-1v4yHhZYodc/WjkbM7SMvmI/AAAAAAAAEVI/z18zz4me1LYm-4NXlN1Gu0D5l0iJXlyBgCLcBGAs/s400/Battery%2BVoltage.png" width="400" /></a></div><br /><u>Wire it Up.</u>&nbsp; Given this voltage divider design, the picture below shows what I did.&nbsp; I chose to grab the LiPo voltage by soldering the 50K resistor to side of the fuse F1.&nbsp; I chose to grab ground by soldering the 125K resistor to TP2 (which is ground).&nbsp; The RTC VBat is taken from the midpoint between the two resistors.&nbsp; I soldered a short red wire from the mid point up to the hole on the Teensy for the RTC VBat.&nbsp; Because these modifications are so small, the modified Tympan fit back into its enclosure without any issues (as shown in the photo at the top of this post).<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-XkmBEPXtiYU/Wjk6oTQMvxI/AAAAAAAAEWY/yBFom7y-Rb0JGqzQKyrihAe2kuu2BWXqQCLcBGAs/s1600/PhysicalWiring.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="646" data-original-width="1214" height="287" src="https://4.bp.blogspot.com/-XkmBEPXtiYU/Wjk6oTQMvxI/AAAAAAAAEWY/yBFom7y-Rb0JGqzQKyrihAe2kuu2BWXqQCLcBGAs/s640/PhysicalWiring.png" width="540" /></a></div><u>Testing the RTC.</u>&nbsp; To test the real time clock, I used one of the Teensy example programs.&nbsp; The RTC example programs are part of the <a href="https://github.com/PaulStoffregen/Time">"Time" library</a> that comes with the Teensysduino installer.&nbsp; If you didn't install the Time library, go back and re-install Teensyduino and you should be good.&nbsp; The specific example program that I used was "<a href="https://github.com/PaulStoffregen/Time/tree/master/examples/TimeTeensy3">TimeTeensy3</a>".&nbsp; I made no modifications to the program.&nbsp; It compiled and uploaded to the Tympan without any issues.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://2.bp.blogspot.com/-h78kVqlork4/WjkcsVw5LJI/AAAAAAAAEVc/5490xyNU2y0rLmhkTuRWeWkXYeCjedirACLcBGAs/s1600/ScreenShotTimeTeensy3.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="1097" data-original-width="1094" height="400" src="https://2.bp.blogspot.com/-h78kVqlork4/WjkcsVw5LJI/AAAAAAAAEVc/5490xyNU2y0rLmhkTuRWeWkXYeCjedirACLcBGAs/s400/ScreenShotTimeTeensy3.png" width="398" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">To test the RTC on the Tympan, I used the "TimeTeensy3" example program that was made for the Teensy.</td></tr></tbody></table><u>It works!</u>&nbsp; The example program is set to simply print the Teeny's time and date to the serial port.&nbsp; it does this once a second.&nbsp; By opening the Arduino Serial Monitor, you can see the time and date from the Tympan.&nbsp; It is correct!&nbsp; I then unplugged the Tympan, turned the Tympan power switch to the off position.&nbsp; Normally, this loss of power would cause the Tympan to lose track of time.&nbsp; On my newly-modified Tympan, the RTC should still be getting power from the LiPo battery via the voltage divider.&nbsp; After a few minutes, I turned the Tympan back on and opened up the Serial Monitor.&nbsp; The Tympan was still showing the correct time and date.&nbsp; It works!<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://2.bp.blogspot.com/-thfuypCooZQ/WjkcxNwSCHI/AAAAAAAAEVg/-G2A3UD4w3UHhsHb-PoKmaEjMQ6MH4XwgCLcBGAs/s1600/TimeScreenShot.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="585" data-original-width="1018" height="228" src="https://2.bp.blogspot.com/-thfuypCooZQ/WjkcxNwSCHI/AAAAAAAAEVg/-G2A3UD4w3UHhsHb-PoKmaEjMQ6MH4XwgCLcBGAs/s400/TimeScreenShot.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The "TimeTeensy3" example program commands the Teensy to print out the RTCs understanding of the time and date.&nbsp; This output can be viewed through the Arduino Serial Monitor.&nbsp; It works!&nbsp; Even after cycling the Tympan's power, it still works!</td></tr></tbody></table><u>How Does RTC Work on the Teensy?</u>&nbsp; As far as I can tell, the RTC on the Teensy is simply a counter.&nbsp; It simply counts the oscillations of a quartz crystal (or whatever).&nbsp; The Teensy knows how many counts occur every second, so it does not the time relative to when the RTC started counting.&nbsp; But when did the RTC start counting?&nbsp; What is the reference time?&nbsp; For the Teensy Time library, the reference time is taken to be the time and date when the sketch was compiled.&nbsp; The library gets the computer's system time and incorporates that into the program.&nbsp; Since the RTC is reset just after compilation is complete, the compile time is a decent approximation for the reference time.&nbsp; No special action from the user is needed.&nbsp; This is a pretty nice setup.<br /><br /><u>Losing RTC Power,</u>&nbsp; The only problem with this setup is if the RTC counter loses power.&nbsp; In my case, this would happen if the LiPo becomes fully drained.&nbsp; When the RTC counter loses power, it loses its count.&nbsp; When power is restored, the RTC will start counting again from zero.&nbsp; The reference time, however, will not have been reset.&nbsp; So, when we ask the RTC what time it is, it'll use the original reference time and we'll get the wrong answer.&nbsp; So, if the LiPo becomes fully discharged, you'll want to reset the RTC by recompiling and re-uploading the program, or by looking at the Time library to figure out how to manually set the time.<br /><br />Overall, I was impressed at how easy it was to get the RTC working on this system.&nbsp; A couple of resistors and a piece of wire?&nbsp; Easy!&nbsp; Now that the Tympan knows the time and date, it'll be much more useful as data logging device.&nbsp; For future users of Tympan, I'm looking forward to incorporating this modification.&nbsp; But, for those of you with the current version of Tympan (Rev C), you'll have to get out the soldering iron.&nbsp; Maybe you're like me and find that to be a fun thing to do!<br /><br />
