---
layout: post
title: Teensy Audio over USB
author: Chip
---


In my last post, where I sent&nbsp;<a href="http://openaudio.blogspot.com/2016/10/teensy-audio-board-first-audio.html">my first analog audio</a> through a&nbsp;<a href="https://www.pjrc.com/teensy/">Teensy</a>, I also discovered that it has the ability to exchange digital audio over its USB link. &nbsp;Whoa. &nbsp;This means that, if I'm developing some snazzy new audio-processing algorithm, I can test it 100% digitally without adding any complications of converting back and forth through analog signals. &nbsp;That is a really powerful capability that'll greatly simplify my audio development. &nbsp;Let's see if it really works!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-vYz5DWstQUM/WA6862I5rlI/AAAAAAAAD-M/52R07EFpl8QaArzI3AGOKRerjrqlCozuwCK4B/s1600/Lead%2BFigure.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="255" src="https://1.bp.blogspot.com/-vYz5DWstQUM/WA6862I5rlI/AAAAAAAAD-M/52R07EFpl8QaArzI3AGOKRerjrqlCozuwCK4B/s400/Lead%2BFigure.png" width="400" /></a></div><br /><u>Discovering USB Audio:</u>&nbsp;&nbsp;I only discovered that the Teensy might be able to do USB Audio while using their&nbsp;<a href="http://www.pjrc.com/teensy/gui/">web-based graphical tool</a>. &nbsp;This is a&nbsp;tool that the Teensy folks ahve created to help people work with their <a href="http://www.pjrc.com/teensy/td_libs_Audio.html">Audio Library</a>. &nbsp;While using that tool, I noticed that there were input/output blocks named "USB". &nbsp;Does this mean that Teensy can exchange audio over USB?!? &nbsp;Really? &nbsp;That's a pretty advanced feature for an electronics board aimed at hobbyists! &nbsp;Does it work?<br /><br /><u>A Simple USB Audio Chain:</u>&nbsp;&nbsp;To give it a try, I configured an audio chain as shown below: one stereo USB input connected to one stereo USB output. &nbsp;The left channel is just connected straight across -- no processing. &nbsp;For the right channel, though, I've inserted a Biquad filter block just so that I can confirm that the Teensy is indeed doing something to the audio. &nbsp;It's a pretty simple setup.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-pP4OjVzFTSM/WA68_c2DPQI/AAAAAAAAD-U/6Ijoj8ULDG8ILhnZPXR9Cg8UBNktX56FgCK4B/s1600/Configure-FirstUSB.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="266" src="https://1.bp.blogspot.com/-pP4OjVzFTSM/WA68_c2DPQI/AAAAAAAAD-U/6Ijoj8ULDG8ILhnZPXR9Cg8UBNktX56FgCK4B/s400/Configure-FirstUSB.png" width="400" /></a></div><br /><u>It Didn't Work:</u>&nbsp;&nbsp;When I exported the audio chain above, loaded it onto the Teensy, and gave it a try, it didn't work. &nbsp;I got silence. &nbsp;I don't know why. &nbsp;So I started messing around...<br /><br /><u>Making it Work</u>:&nbsp; To get the USB Audio to work, I found that I had to engage the audio board's hardware in some way. &nbsp;One way to make it work is shown below: add a SGTL5000 block for the Audio Board, and add an I2S block to be the output of the Audio Board. &nbsp;I connected the I2S output to be just like the USB output. &nbsp;Now, whatever the Teensy is sending out via USB will also be present at the headphone jack. &nbsp;Sure, it seems like an unnecessary complication if I just want to use USB for my audio, but it's kinda cool that it's so easy to output to multiple targets simultaneously.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-22nMw1JNHkQ/WA69DfCe9CI/AAAAAAAAD-c/XVZAsNKbRUIzDEvIRrJHTBA7OFgB7NXcACK4B/s1600/Configure-SecondUSB.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="266" src="https://4.bp.blogspot.com/-22nMw1JNHkQ/WA69DfCe9CI/AAAAAAAAD-c/XVZAsNKbRUIzDEvIRrJHTBA7OFgB7NXcACK4B/s400/Configure-SecondUSB.png" width="400" /></a></div><br /><u>Completing the Arduino Code:</u>&nbsp; The graphical web-based tool shown above doesn't produce a complete program to load onto the Teensy -- it just gets you started. &nbsp;When I hit the "Export" button, it gave me all of the code to setup the hardware and make the connections, but I still needed to write the last bit of code to make it run. &nbsp;As usual, I did my coding in the Arduino IDE because it's easiest.<br /><br /><u>My Code:</u>&nbsp;&nbsp;The screenshot below shows the Arduino sketch that I used for this demo (it's on my GitHub <a href="https://github.com/chipaudette/OpenAudio_blog/tree/master/2016-10-24%20Teensy%20Audio%20USB/Arduino/USB_Audio_Testing">here</a>). &nbsp;At the top is the big block of code that was exported from the web-based tool. &nbsp;Easy. &nbsp;Then, at the bottom, I added the setup() and loop() functions. &nbsp;As you can see, the setup() function configures the SGTL5000 audio board and it sets the biquad filter to be a low-pass filter at 500 Hz. &nbsp;The loop() function does nothing.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-0x9yxi9IR7U/WA69IDWZmhI/AAAAAAAAD-k/aRx_pkuoQ8UuXbxLQVgUCGcIw6ISWm7iQCK4B/s1600/ArduinoCode.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="https://2.bp.blogspot.com/-0x9yxi9IR7U/WA69IDWZmhI/AAAAAAAAD-k/aRx_pkuoQ8UuXbxLQVgUCGcIw6ISWm7iQCK4B/s400/ArduinoCode.png" width="315" /></a></div><br /><u>Tell the Compiler about USB Audio!</u>&nbsp; The only trick to using the USB audio is that you need to tell the compiler that you want the Teensy to run in USB Audio mode. &nbsp;So, prior to compiling and uploading this Arduino sketch, go under the "Tools" menu, click on "USB Type" and select "Audio". &nbsp;Notice that there are many other choices, including "Serial", "Keyboard, "MIDI", "Audio" and "No USB". &nbsp; Normally, one uses "Serial" so that Serial.println() is able to print messages to the Serial Monitor. &nbsp;But, for this demo, I want "Audio".<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-5aVt7Y-mXCE/WA69MdnYRWI/AAAAAAAAD-s/J_WteUEcoyIMxJDFkLHQVsbIcymNS330gCK4B/s1600/ArduinoCode-SelectAudio.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="https://2.bp.blogspot.com/-5aVt7Y-mXCE/WA69MdnYRWI/AAAAAAAAD-s/J_WteUEcoyIMxJDFkLHQVsbIcymNS330gCK4B/s400/ArduinoCode-SelectAudio.png" width="361" /></a></div><br /><u>Loading onto the Teensy:</u>&nbsp; Once you change the USB setting to Audio, you can compile and upload to the Teensy. &nbsp;The first time you do it, it'll probably upload to the Teensy without any issue. &nbsp;Great! &nbsp;But, once it is in USB Audio mode, future programs won't appear to upload automatically. &nbsp;Why? &nbsp;Well, once the USB link set for Audio, the Teensy can't get reprogramming commands over that same USB link. &nbsp;What's the solution? &nbsp;After the Arduino IDE has finished compiling, simply press the Teensy's reset button (picture below). &nbsp;After a reset, the Teensy knows to check in with the PC prior to switching over to Audio mode. &nbsp;It will automatically get any new program waiting for it. &nbsp;It's a small extra step, but I didn't find it to be a problem at all.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-ITUzC0qGAMI/WA69RQpVTRI/AAAAAAAAD-0/1pA4WZ3xlkQPRW34P-fkPWUBjDkjgCxqwCK4B/s1600/PressTheButton.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="273" src="https://3.bp.blogspot.com/-ITUzC0qGAMI/WA69RQpVTRI/AAAAAAAAD-0/1pA4WZ3xlkQPRW34P-fkPWUBjDkjgCxqwCK4B/s400/PressTheButton.png" width="400" /></a></div><br /><u>Testing Using Audacity</u>: &nbsp;Once the Teensy is in USB Audio mode, the Teensy appears to your PC as if it is a soundcard. &nbsp;So, you can now send and receive audio data to it using any audio recording program. &nbsp;For this demo, I used <a href="http://www.audacityteam.org/">Audacity </a>because it is free. <br /><br /><u>Configuring Audacity:</u>&nbsp;&nbsp;With the Teensy attached, my computer now has two soundcards: (1) its built-in soundcard and (2) the Teensy. &nbsp;Once Audacity launches, I configured Audacity to use the Teensy as the soundcard instead of the built-in one. &nbsp;The screenshot below shows the five settings that I changed in Audacity. &nbsp;On my computer (Windows 7), the Teensy cryptically appeared as "Digital Audio Interface (2-Tee" [sic], which wasn't as quite helpful as informative as it could have been, but it was good enough for me to choose the right item.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-qL3biGjEmwQ/WA69X3X9L3I/AAAAAAAAD-8/LcvVOmX97iQd0hyhSrsfuPW9kzTzHlxTQCK4B/s1600/Configure-Audacity.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="258" src="https://1.bp.blogspot.com/-qL3biGjEmwQ/WA69X3X9L3I/AAAAAAAAD-8/LcvVOmX97iQd0hyhSrsfuPW9kzTzHlxTQCK4B/s400/Configure-Audacity.png" width="400" /></a></div><br /><u>First USB Audio:</u>&nbsp; For this test, I'm want to send audio out over USB (to the Teensy) and record audio coming from USB (from the Teensy). &nbsp;So, I need to start by creating a test signal to send out over USB. &nbsp;Under the "Generate" menu, I chose "Chirp" and made a linear frequency sweep from 100 Hz to 4000 Hz. &nbsp;This appeared as a single mono track in Audacity. &nbsp;That's all the preparation that I needed to do. &nbsp;Now, I simply hit the red record button. &nbsp;Audacity started playing out the chirp audio to the Teensy while recording the audio coming back from the Teensy. &nbsp;The result is shown in the screenshot below.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-8kpVuT6XCH8/WA86e7QJvvI/AAAAAAAAD_U/GdH4tfhrYSgY2duqco0B-IbaHf-bvDjagCK4B/s1600/Results%2Bin%2BAudacity.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="311" src="https://2.bp.blogspot.com/-8kpVuT6XCH8/WA86e7QJvvI/AAAAAAAAD_U/GdH4tfhrYSgY2duqco0B-IbaHf-bvDjagCK4B/s400/Results%2Bin%2BAudacity.png" width="400" /></a></div><br /><u>Success!</u>&nbsp; The screen shot shows two audio files. &nbsp;Both files are shown in "spectrogram" view (60 dB dynamic range). &nbsp;The top file contains the original (mono) frequency sweep generated by Audacity. &nbsp;This is what was sent to the Teensy over the USB Audio link. &nbsp;The bottom file shows the stereo audio recorded from the Teensy. &nbsp;The left channel had no processing being performed by the Teensy and it does indeed appear to be a copy of the original signal. &nbsp;The right channel, though, was being processed by the Teensy by its 500 Hz low-pass biquad filter. &nbsp;As can be seen, the high frequencies are attenuated -- the gentle roll-off is as expected from a biquad filter. &nbsp;This was amazingly easy!<br /><br /><u>Future Use:</u>&nbsp;&nbsp;While I'm very impressed that this capability exists at all, it's not perfect. &nbsp;In additional testing, I occasionally found hiccups or other artifacts in the audio stream coming back from the Teensy. &nbsp;But, most of the time, this USB Audio link worked really well. &nbsp;It'll be great for debugging my audio projects. &nbsp;Anytime I have any question about the negative effects of my analog components, I can simply switch over to USB Audio to avoid the whole problem. &nbsp;It'll be a great tool to have in my audio hacking toolbox.<br /><br />
